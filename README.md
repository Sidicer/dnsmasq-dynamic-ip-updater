# Dnsmasq Dynamic IP Updater

*A NetworkManager dispatcher script that automatically updates dnsmasq DNS configurations when network interfaces receive new IP addresses via DHCP.*

This script resolves the issue of local DNS resolution failure after network changes by ensuring services remain accessible via their domain names without manual intervention. It's particularly valuable in environments where `dnsmasq` serves as a **secondary** DNS server on the host, enabling subdomain resolution for reverse proxy configurations.  
For example, in a setup with nginx reverse proxying requests to `service.homelab.lan`, standard `/etc/hosts` entries (`127.0.0.1 homelab.lan`) would be insufficient. This script maintains the proper DNS configuration automatically as network conditions change.

## How it works

NetworkManager when doing any action to any of the interfaces calls scripts from `/etc/NetworkManager/dispatcher.d/` in numerical order. When this script is triggered it first confirms that the event happened on the expected network interface, then confirms that the action was either `up` or `dhcp4-change` and if so writes dnsmasq configuration file, validates it and if everything is correct reloads dnsmasq

## Prerequisites

It uses `dispatcher` built into **NetworkManager** which triggers shell scripts after any action within `NetworkManager`

```sh
# Install dependencies
pacman -S bash NetworkManager dnsmasq
# Modify dnsmasq to read configuration from additional directory
echo "conf-dir=/etc/dnsmasq.d,.bak" | sudo tee -a "/etc/dnsmasq.conf"
```

## Installation

```sh
curl -sSL https://raw.githubusercontent.com/Sidicer/dnsmasq-dynamic-ip-updater/refs/heads/main/10-update-dnsmasq.sh | \
  sudo tee /etc/NetworkManager/dispatcher.d/10-update-dnsmasq.sh > /dev/null && \
  sudo chmod +x /etc/NetworkManager/dispatcher.d/10-update-dnsmasq.sh

# Set DNSMASQ_DOMAIN & MAIN_INTERFACE that matches your configuration
echo "DNSMASQ_DOMAIN=homelab.lan\nMAIN_INTERFACE=enp2s0" | \
  sudo tee /etc/NetworkManager/dispatcher.d/.env-update-dnsmasq
```
> [!NOTE]
> If `.env-update-dnsmasq` doesn't exist and the script was not manually edited the fallbacks are:
> - `DNSMASQ_DOMAIN`: `homelab.lan`
> - `MAIN_INTERFACE`: `ip addr | awk '/2: / {print $2}' | cut -d: -f1`

### Test
Simulate an action by NetworkManager
```sh
sudo /etc/NetworkManager/dispatcher.d/10-update-dnsmasq.sh enp2s0 up
# If success: output should be empty
```

Then check both dnsmasq new config file and syslog to confirm success:
```sh
cat /etc/dnsmasq.d/<HOSTNAME>.conf
# EXPECTED OUTPUT:
    # GENERATED BY /etc/NetworkManager/dispatcher.d/10-update-dnsmasq.sh
    # UPDATED AT Sun Mar  9 02:22:26 AM EET 2025
    address=/.<DNSMASQ_DOMAIN>/<IP>

sudo journalctl -e
# EXPECTED OUTPUT:
    root[5358]: [NM-Dispatcher 10-update-dnsmasq] Received action 'up' on interface 'enp2s0'
    root[5358]: [NM-Dispatcher 10-update-dnsmasq] New IP for enp2s0 is <IP>. Updating '/etc/dnsmasq.d/<HOSTNAME>.conf'
    root[5358]: [NM-Dispatcher 10-update-dnsmasq] Validating /etc/dnsmasq.d/<HOSTNAME>.conf
    root[5358]: [NM-Dispatcher 10-update-dnsmasq] Reloading dnsmasq daemon
    systemd[1]: Reloading dnsmasq - A lightweight DHCP and caching DNS server...
    dnsmasq[1489]: read /etc/hosts - 3 names
    systemd[1]: Reloaded dnsmasq - A lightweight DHCP and caching DNS server.
    root[5358]: [NM-Dispatcher 10-update-dnsmasq] Dnsmasq successfully reloaded
```

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.